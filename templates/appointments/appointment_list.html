{% extends 'base/base.html' %}

{% block title %}Quản lý lịch hẹn - {{ block.super }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-calendar-alt"></i> Quản lý lịch hẹn</h2>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addAppointmentModal">
        <i class="fas fa-plus"></i> Đặt lịch hẹn
    </button>
</div>

<!-- Search and Filter -->
<div class="card mb-4">
    <div class="card-body">
        <form id="search-form" class="row g-3">
            <div class="col-md-3">
                <label for="search-query" class="form-label">Tìm kiếm</label>
                <input type="text" class="form-control" id="search-query" 
                       placeholder="Mã lịch hẹn, tên bệnh nhân...">
            </div>
            <div class="col-md-2">
                <label for="status-filter" class="form-label">Trạng thái</label>
                <select class="form-select" id="status-filter">
                    <option value="">Tất cả</option>
                    <option value="SCHEDULED">Đã đặt lịch</option>
                    <option value="CONFIRMED">Đã xác nhận</option>
                    <option value="CHECKED_IN">Đã check-in</option>
                    <option value="IN_PROGRESS">Đang khám</option>
                    <option value="COMPLETED">Hoàn thành</option>
                    <option value="CANCELLED">Đã hủy</option>
                    <option value="NO_SHOW">Không đến</option>
                </select>
            </div>
            <div class="col-md-2">
                <label for="priority-filter" class="form-label">Ưu tiên</label>
                <select class="form-select" id="priority-filter">
                    <option value="">Tất cả</option>
                    <option value="LOW">Thấp</option>
                    <option value="NORMAL">Bình thường</option>
                    <option value="HIGH">Cao</option>
                    <option value="URGENT">Khẩn cấp</option>
                </select>
            </div>
            <div class="col-md-2">
                <label for="department-filter" class="form-label">Khoa</label>
                <select class="form-select" id="department-filter">
                    <option value="">Tất cả khoa</option>
                </select>
            </div>
            <div class="col-md-2">
                <label for="date-filter" class="form-label">Ngày khám</label>
                <input type="date" class="form-control" id="date-filter">
            </div>
            <div class="col-md-1">
                <label class="form-label">&nbsp;</label>
                <button type="submit" class="btn btn-outline-primary d-block">
                    <i class="fas fa-search"></i>
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Appointment Table -->
<div class="card">
    <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0">Danh sách lịch hẹn</h5>
            <small class="text-muted">Tổng: <span id="total-count">0</span> lịch hẹn</small>
        </div>
        
        <div class="table-responsive">
            <table class="table table-hover text-center align-middle" id="appointments-table">
                <thead class="table-light text-center">
                    <tr>
                        <th>Mã lịch hẹn</th>
                        <th>Bệnh nhân</th>
                        <th>Bác sĩ</th>
                        <th>Khoa</th>
                        <th>Ngày giờ</th>
                        <th>Loại</th>
                        <th>Ưu tiên</th>
                        <th>Trạng thái</th>
                        <th>Thao tác</th>
                    </tr>
                </thead>
                <tbody id="appointments-table-body" class="text-center">
                    <tr>
                        <td colspan="9" class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Đang tải...</span>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        <nav id="pagination-nav" class="mt-3">
            <ul class="pagination justify-content-center" id="pagination-container">
                <!-- Pagination will be rendered here -->
            </ul>
        </nav>
    </div>
</div>

<!-- Add Appointment Modal -->
<div class="modal fade" id="addAppointmentModal" tabindex="-1" aria-labelledby="addAppointmentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addAppointmentModalLabel">
                    <i class="fas fa-calendar-plus"></i> Đặt lịch hẹn mới
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="add-appointment-form">
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="add-patient" class="form-label">Bệnh nhân <span class="text-danger">*</span></label>
                            <select class="form-select" id="add-patient" name="patient" required>
                                <option value="">Chọn bệnh nhân</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="add-doctor" class="form-label">Bác sĩ <span class="text-danger">*</span></label>
                            <select class="form-select" id="add-doctor" name="doctor" required>
                                <option value="">Chọn bác sĩ</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="add-department" class="form-label">Khoa <span class="text-danger">*</span></label>
                            <select class="form-select" id="add-department" name="department" required>
                                <option value="">Chọn khoa</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="add-appointment-type" class="form-label">Loại lịch hẹn <span class="text-danger">*</span></label>
                            <select class="form-select" id="add-appointment-type" name="appointment_type" required>
                                <option value="">Chọn loại</option>
                                <option value="CONSULTATION">Tư vấn</option>
                                <option value="FOLLOW_UP">Tái khám</option>
                                <option value="EMERGENCY">Cấp cứu</option>
                                <option value="PROCEDURE">Thủ thuật</option>
                                <option value="SURGERY">Phẫu thuật</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="add-appointment-date" class="form-label">Ngày khám <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" id="add-appointment-date" name="appointment_date" required>
                        </div>
                        <div class="col-md-6">
                            <label for="add-appointment-time" class="form-label">Giờ khám <span class="text-danger">*</span></label>
                            <input type="time" class="form-control" id="add-appointment-time" name="appointment_time" required>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="add-priority" class="form-label">Mức ưu tiên</label>
                            <select class="form-select" id="add-priority" name="priority">
                                <option value="NORMAL">Bình thường</option>
                                <option value="LOW">Thấp</option>
                                <option value="HIGH">Cao</option>
                                <option value="URGENT">Khẩn cấp</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="add-duration" class="form-label">Thời gian dự kiến (phút)</label>
                            <input type="number" class="form-control" id="add-duration" name="estimated_duration" value="30" min="15" max="120">
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-12">
                            <label for="add-chief-complaint" class="form-label">Lý do khám <span class="text-danger">*</span></label>
                            <textarea class="form-control" id="add-chief-complaint" name="chief_complaint" rows="2" required></textarea>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-12">
                            <label for="add-notes" class="form-label">Ghi chú</label>
                            <textarea class="form-control" id="add-notes" name="notes" rows="2"></textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Đặt lịch
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- View Appointment Modal -->
<div class="modal fade" id="viewAppointmentModal" tabindex="-1" aria-labelledby="viewAppointmentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewAppointmentModalLabel">
                    <i class="fas fa-calendar-alt"></i> Chi tiết lịch hẹn
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <table class="table table-borderless">
                            <tr>
                                <td><strong>Mã lịch hẹn:</strong></td>
                                <td id="view-appointment-number"></td>
                            </tr>
                            <tr>
                                <td><strong>Bệnh nhân:</strong></td>
                                <td id="view-patient-name"></td>
                            </tr>
                            <tr>
                                <td><strong>Bác sĩ:</strong></td>
                                <td id="view-doctor-name"></td>
                            </tr>
                            <tr>
                                <td><strong>Khoa:</strong></td>
                                <td id="view-department-name"></td>
                            </tr>
                            <tr>
                                <td><strong>Ngày khám:</strong></td>
                                <td id="view-appointment-date"></td>
                            </tr>
                            <tr>
                                <td><strong>Giờ khám:</strong></td>
                                <td id="view-appointment-time"></td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <table class="table table-borderless">
                            <tr>
                                <td><strong>Loại lịch hẹn:</strong></td>
                                <td id="view-appointment-type"></td>
                            </tr>
                            <tr>
                                <td><strong>Mức ưu tiên:</strong></td>
                                <td id="view-priority"></td>
                            </tr>
                            <tr>
                                <td><strong>Trạng thái:</strong></td>
                                <td id="view-status"></td>
                            </tr>
                            <tr>
                                <td><strong>Thời gian dự kiến:</strong></td>
                                <td id="view-duration"></td>
                            </tr>
                            <tr>
                                <td><strong>Ngày tạo:</strong></td>
                                <td id="view-created-at"></td>
                            </tr>
                            <tr>
                                <td><strong>Người đặt:</strong></td>
                                <td id="view-booked-by"></td>
                            </tr>
                        </table>
                    </div>
                </div>
                <div class="row">
                    <div class="col-12">
                        <strong>Lý do khám:</strong>
                        <p id="view-reason" class="mt-2"></p>
                    </div>
                    <div class="col-12">
                        <strong>Ghi chú:</strong>
                        <p id="view-notes" class="mt-2"></p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                <div id="view-appointment-actions">
                    <!-- Action buttons will be added here based on appointment status -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Appointment Modal -->
<div class="modal fade" id="editAppointmentModal" tabindex="-1" aria-labelledby="editAppointmentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editAppointmentModalLabel">
                    <i class="fas fa-edit"></i> Chỉnh sửa lịch hẹn
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="edit-appointment-form">
                <div class="modal-body">
                    <input type="hidden" id="edit-appointment-id" name="id">
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="edit-appointment-date" class="form-label">Ngày khám <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" id="edit-appointment-date" name="appointment_date" required>
                        </div>
                        <div class="col-md-6">
                            <label for="edit-appointment-time" class="form-label">Giờ khám <span class="text-danger">*</span></label>
                            <input type="time" class="form-control" id="edit-appointment-time" name="appointment_time" required>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="edit-priority" class="form-label">Mức ưu tiên</label>
                            <select class="form-select" id="edit-priority" name="priority">
                                <option value="LOW">Thấp</option>
                                <option value="NORMAL">Bình thường</option>
                                <option value="HIGH">Cao</option>
                                <option value="URGENT">Khẩn cấp</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="edit-status" class="form-label">Trạng thái</label>
                            <select class="form-select" id="edit-status" name="status">
                                <option value="SCHEDULED">Đã đặt lịch</option>
                                <option value="CONFIRMED">Đã xác nhận</option>
                                <option value="CHECKED_IN">Đã check-in</option>
                                <option value="IN_PROGRESS">Đang khám</option>
                                <option value="COMPLETED">Hoàn thành</option>
                                <option value="CANCELLED">Đã hủy</option>
                                <option value="NO_SHOW">Không đến</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-12">
                            <label for="edit-chief-complaint" class="form-label">Lý do khám <span class="text-danger">*</span></label>
                            <textarea class="form-control" id="edit-chief-complaint" name="chief_complaint" rows="2" required></textarea>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-12">
                            <label for="edit-notes" class="form-label">Ghi chú</label>
                            <textarea class="form-control" id="edit-notes" name="notes" rows="2"></textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Cập nhật
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{% load static %}
<script src="{% static 'js/appointments.js' %}"></script>
{% endblock %}
